<%- include('../partials/header') %>

<h2 class="page-title", style="text-align: center;">Ride the Bus</h2>

<div class="blackjack-table"> <!-- reusing BJ table style for consistency -->
    
    <!-- Game Instructions -->
    <div class="hand-section">
        <p style="color: gold; font-size: 18px;">
            Guess correctly to climb the multiplier ladder!<br>
            Red/Black, Higher/Lower, Inside/Outside, Suit  <br>
            Aces are 11!!
        </p>
    </div>

    <!-- Current Card Display -->
    <div class="hand-section" id="rtb-guess-section" style="display:none;">
        <h3>Current Card</h3>
        <div class="cards-row">
            <div class="card">?</div>
        </div>
    </div>

    <!-- BETTING SECTION -->
    <div id="rtb-bet-section" class="hand-section">
        <h3>Select Your Bet</h3>

        <select id="rtb-bet-amount" class="bet-select">
        <option value="10">$10</option>
        <option value="25">$25</option>
        <option value="50">$50</option>
        <option value="100">$100</option>
        <option value="1000">$1000</option>
        </select>

        <button id="rtb-place-bet" class="btn game-btn">Place Bet</button>
    </div>

    <!-- Guess Section -->
    <div class="hand-section">
        <h3>Make Your Guess</h3>

        <!-- STEP 1: Even / Odd -->
        <div id="step-red-black" class="controls">
            <button class="btn game-btn">Red</button>
            <button class="btn game-btn">Black</button>
        </div>

        <!-- STEP 2: Higher / Lower -->
        <div id="step-high-low" class="controls" style="display:none;">
            <button class="btn game-btn">Higher</button>
            <button class="btn game-btn">Lower</button>
        </div>

        <!-- STEP 3: Inside / Outside -->
        <div id="step-in-out" class="controls" style="display:none;">
            <button class="btn game-btn">Inside</button>
            <button class="btn game-btn">Outside</button>
        </div>

        <!-- STEP 4: Guess Suit -->
        <div id="step-suit" class="controls" style="display:none;">
            <button class="btn game-btn" data-suit="&spades;">&spades; Spades</button>
            <button class="btn game-btn" data-suit="&clubs;">&clubs; Clubs</button>
            <button class="btn game-btn red" data-suit="&hearts;">&hearts; Hearts</button>
            <button class="btn game-btn red" data-suit="&diams;">&diams; Diamonds</button>
        </div>
    </div>

    <!-- Multiplier Display -->
    <div class="wallet-box" style="margin-top: 30px;">
        <p style="font-size: 20px;">Current Multiplier</p>
        <p class="wallet-amount" id="rtb-multiplier">x1</p>
    </div>

    <!-- Result -->
    <div id="rtb-result" class="hand-section" style="display:none;">
        <h3 style="color: gold;">Result</h3>
        <p id="rtb-message" style="font-size: 20px;"></p>
    </div>

    <!-- Restart + Cash Out (side-by-side) -->
    <div class="controls" id="action-buttons" style="display:flex; justify-content:center; gap:20px; margin-top:20px;">
    
        <!-- CASH OUT (hidden at beginning) -->
        <button id="rtb-cashout" class="btn game-btn" 
                style="background:#f1c40f; color:black; display:none;">
            Cash Out
        </button>

        <!-- RESTART (hidden during game) -->
        <a href="/games/ridethebus" id="rtb-restart" 
        class="btn restart-btn" style="display:none;">
            Restart
        </a>

    </div>

</div>


</div>
<div style="text-align: center;">
    <a href="/feature/" class="btn">Game Menu</a>
</div>

<script>
// ==========================
// PLACE BET
// ==========================
document.getElementById("rtb-place-bet").addEventListener("click", async () => {
    const amount = document.getElementById("rtb-bet-amount").value;

    const response = await fetch("/games/ridethebus/bet", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bet: amount })
    });

    const data = await response.json();

    if (!data.success) {
        alert(data.message);
        return;
    }

    // Hide bet section, show guessing section
    document.getElementById("rtb-bet-section").style.display = "none";
    document.getElementById("rtb-guess-section").style.display = "block";
    document.getElementById("rtb-cashout").style.display = "block";

});

// ==========================
// SEND GUESS
// ==========================
async function sendGuess(guess) {
    const response = await fetch("/games/ridethebus/guess", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ guess: guess })
    });

    const data = await response.json();
    updateUI(data);
}

// ==========================
// CASH OUT
// ==========================
document.getElementById("rtb-cashout").addEventListener("click", async () => {

    const response = await fetch("/games/ridethebus/cashout", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
    });

    const data = await response.json();

    updateUI(data); // reuse existing UI system
});

// ==========================
// ATTACH BUTTON EVENTS
// ==========================
document.querySelectorAll(".game-btn").forEach(button => {
    button.addEventListener("click", () => {
        // Suit buttons use data-suit attribute
        const suitAttr = button.getAttribute("data-suit");

        const guess = suitAttr || button.innerText.trim();

        // Only send guesses AFTER betting
        if (document.getElementById("rtb-guess-section").style.display !== "none") {
            sendGuess(guess);
        }
    });
});

// ==========================
// UPDATE UI AFTER GUESS
// ==========================
function updateUI(data) {
    const cardDiv = document.querySelector(".cards-row .card");
    const resultDiv = document.getElementById("rtb-result");
    const msg = document.getElementById("rtb-message");

    // Show card
    cardDiv.innerHTML = `${data.card.rank}${data.card.suitHtml}`;
    cardDiv.className = `card ${data.card.color}`;

    // Update multiplier display
    document.getElementById("rtb-multiplier").innerText = "x" + data.multiplier;

    // ==========================
    // GAME OVER
    // ==========================
    if (data.gameOver) {
        resultDiv.style.display = "block";
        msg.innerText = data.message;
        document.getElementById("rtb-cashout").style.display = "none";
        document.getElementById("rtb-restart").style.display = "block";

        // Hide ALL guess control groups EXCEPT restart
        document.querySelectorAll(".controls").forEach(div => {
            if (div.id !== "restart-container") {
                div.style.display = "none";
            }
        });

        return; // stop here
    }

    // ==========================
    // SHOW NEXT STEP BUTTONS
    // ==========================
    document.getElementById("step-red-black").style.display = data.step === 1 ? "block" : "none";
    document.getElementById("step-high-low").style.display = data.step === 2 ? "block" : "none";
    document.getElementById("step-in-out").style.display = data.step === 3 ? "block" : "none";
    document.getElementById("step-suit").style.display = data.step === 4 ? "block" : "none";
}
</script>



<%- include('../partials/footer') %>
